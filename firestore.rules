rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isUserAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isRole(role) {
      return isUserAuthenticated() && getUserRole() == role;
    }
    
    function isOneOfRoles(roles) {
      return isUserAuthenticated() && getUserRole() in roles;
    }

    function isOwner(docData) {
      return docData.ownerId == request.auth.uid;
    }
    
    function isCreator(docData) {
      return docData.creadoPorId == request.auth.uid || docData.userId == request.auth.uid;
    }


    // --- Collection Rules ---

    // USERS: Users can read basic info from others, but only modify their own name/photo. Role changes only by admins.
    match /users/{userId} {
      allow read: if isUserAuthenticated();
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId && !('role' in request.resource.data) // Allow user to update their own profile, but not their role
                      || isOneOfRoles(['Jefe', 'Gerencia', 'Admin']); // Admins can update anything
      allow delete: if isOneOfRoles(['Jefe', 'Gerencia', 'Admin']);
    }

    // CLIENTS: Asesores can manage their own clients. Bosses can manage all.
    match /clients/{clientId} {
      allow get: if isUserAuthenticated() && (isOwner(resource.data) || isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']));
      allow list: if isUserAuthenticated(); // Allow listing for dashboard counts, app filters by owner.
      allow create: if isUserAuthenticated();
      allow update: if isUserAuthenticated() && (isOwner(resource.data) || isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']));
      allow delete: if isOneOfRoles(['Jefe', 'Gerencia']);
    }
    
    // PROSPECTS: Asesores can manage their own prospects. Bosses can manage all.
    match /prospects/{prospectId} {
      allow get: if isUserAuthenticated() && (isOwner(resource.data) || isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']));
      allow list: if isUserAuthenticated(); // Allow listing for dashboard counts.
      allow create: if isUserAuthenticated();
      allow update: if isUserAuthenticated() && (isOwner(resource.data) || isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']));
      allow delete: if isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']);
    }

    // OPPORTUNITIES: Asesores can manage opps for their clients. Bosses can manage all.
    match /opportunities/{opportunityId} {
      function isOpportunityOwner() {
        let client = get(/databases/$(database)/documents/clients/$(request.resource.data.clientId));
        return client.data.ownerId == request.auth.uid;
      }
      
      allow get: if isUserAuthenticated(); // More complex ownership, handled by list + app logic.
      allow list: if isUserAuthenticated();
      allow create: if isUserAuthenticated() && isOpportunityOwner();
      allow update: if isUserAuthenticated() && (isOpportunityOwner() || isOneOfRoles(['Jefe', 'Gerencia']));
      allow delete: if isOneOfRoles(['Jefe', 'Gerencia']);
    }
    
    // PEOPLE: Contacts related to clients. Similar rules to clients.
    match /people/{personId} {
      allow read, create, update: if isUserAuthenticated(); // Permissions are implicitly handled by client access.
      allow delete: if isOneOfRoles(['Jefe', 'Gerencia']);
    }
    
    // AGENCIES: Managed by admins. Read by all.
    match /agencies/{agencyId} {
      allow read: if isUserAuthenticated();
      allow create, update, delete: if isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']);
    }
    
    // ACTIVITIES (System Logs): Read-only for most. Created by server-side logic.
    match /activities/{activityId} {
      allow read: if isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']);
      allow list: if isUserAuthenticated(); // Required for dashboard feeds.
      allow create, update, delete: if false; // Only server can write.
    }
    
    // CLIENT-ACTIVITIES (User Logs): Users can create for their clients.
    match /client-activities/{activityId} {
      function isActivityOwner() {
        let client = get(/databases/$(database)/documents/clients/$(request.resource.data.clientId));
        return client.data.ownerId == request.auth.uid;
      }

      allow read: if isUserAuthenticated(); // Assumes app-level filtering.
      allow create: if isUserAuthenticated() && isActivityOwner();
      allow update: if isUserAuthenticated() && (isCreator(resource.data) || isActivityOwner() || isOneOfRoles(['Jefe', 'Gerencia']));
      allow delete: if isOneOfRoles(['Jefe', 'Gerencia']);
    }
    
    // INVOICES: Linked to opportunities.
    match /invoices/{invoiceId} {
      function isInvoiceOwner() {
        let opp = get(/databases/$(database)/documents/opportunities/$(request.resource.data.opportunityId));
        let client = get(/databases/$(database)/documents/clients/$(opp.data.clientId));
        return client.data.ownerId == request.auth.uid;
      }

      allow list: if isUserAuthenticated();
      allow get, create, update: if isUserAuthenticated() && (isInvoiceOwner() || isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']));
      allow delete: if isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']);
    }
    
    // CANJES: Complex logic, handled by roles.
    match /canjes/{canjeId} {
      allow read: if isUserAuthenticated();
      allow create: if isUserAuthenticated();
      allow update: if isUserAuthenticated() && (isCreator(resource.data) || isOwner(resource.data) || isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']));
      allow delete: if isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']);
    }
    
    // PROGRAMS & COMMERCIAL ITEMS (Grilla): Managed by admins/bosses. Read by all.
    match /programs/{programId} {
      allow read: if isUserAuthenticated();
      allow create, update, delete: if isOneOfRoles(['Jefe', 'Gerencia', 'Administracion']);
    }
    
    match /commercial_items/{itemId} {
      allow read: if isUserAuthenticated();
      allow create: if isUserAuthenticated();
      allow update, delete: if isUserAuthenticated(); // Simplified for now, complex logic in app. Let's trust the app logic for who can edit what (e.g. their own client's pauta)
    }
  }
}
