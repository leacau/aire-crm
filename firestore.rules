rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isUserAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isRole(role) {
      return isUserAuthenticated() && getUserRole() == role;
    }
    
    function isOneOfRoles(roles) {
      let userRole = getUserRole();
      return isUserAuthenticated() && (userRole in roles || (userRole == 'Jefe' && 'Asesor' in roles) || (userRole == 'Gerencia' && ('Asesor' in roles || 'Jefe' in roles)));
    }

    function isOwner(docData) {
      return docData.ownerId == request.auth.uid;
    }
    
    function isCreator(docData) {
      return docData.creadoPorId == request.auth.uid || docData.userId == request.auth.uid;
    }
    
    function isManagement() {
      return isOneOfRoles(['Jefe', 'Gerencia', 'Admin', 'Administracion']);
    }


    // --- Collection Rules ---

    // USERS: Users can read basic info from others, but only modify their own name/photo. Role changes only by admins.
    match /users/{userId} {
      allow read: if isUserAuthenticated();
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId && !('role' in request.resource.data) // Allow user to update their own profile, but not their role
                      || isManagement(); // Admins can update anything
      allow delete: if isManagement();
    }

    // CLIENTS: Asesores can manage their own clients. Bosses can manage all.
    match /clients/{clientId} {
      allow get: if isUserAuthenticated() && (isOwner(resource.data) || isManagement());
      allow list: if isUserAuthenticated(); // App filters by owner. Required for advisors to find their clients.
      allow create: if isUserAuthenticated();
      allow update: if isUserAuthenticated() && (isOwner(resource.data) || isManagement());
      allow delete: if isManagement();
    }
    
    // PROSPECTS: Asesores can manage their own prospects. Bosses can manage all.
    match /prospects/{prospectId} {
      allow get: if isUserAuthenticated() && (isOwner(resource.data) || isManagement());
      allow list: if isUserAuthenticated(); // App filters by owner.
      allow create: if isUserAuthenticated();
      allow update: if isUserAuthenticated() && (isOwner(resource.data) || isManagement());
      allow delete: if isManagement();
    }

    // OPPORTUNITIES: Asesores can manage opps for their clients. Bosses can manage all.
    match /opportunities/{opportunityId} {
      function isOpportunityOwner() {
        return resource.data.ownerId == request.auth.uid;
      }
      
      allow get: if isUserAuthenticated() && (isOpportunityOwner() || isManagement());
      allow list: if isUserAuthenticated() && (isManagement() || request.query.where.ownerId == request.auth.uid);
      allow create: if isUserAuthenticated();
      allow update: if isUserAuthenticated() && (isOpportunityOwner() || isManagement());
      allow delete: if isManagement();
    }
    
    // PEOPLE: Contacts related to clients. Similar rules to clients.
    match /people/{personId} {
      allow read, create, update: if isUserAuthenticated(); // Permissions are implicitly handled by client access.
      allow delete: if isManagement();
    }
    
    // AGENCIES: Managed by admins. Read by all.
    match /agencies/{agencyId} {
      allow read: if isUserAuthenticated();
      allow create, update, delete: if isManagement();
    }
    
    // ACTIVITIES (System Logs): Read-only for most.
    match /activities/{activityId} {
      allow read: if isManagement();
      allow list: if isManagement();
      allow create: if false;
      allow update, delete: if false;
    }
    
    // CLIENT-ACTIVITIES (User Logs): Users can create for their clients.
    match /client-activities/{activityId} {
      function isActivityOwner() {
        let client = get(/databases/$(database)/documents/clients/$(resource.data.clientId));
        return client.data.ownerId == request.auth.uid;
      }

      allow read: if isUserAuthenticated(); // Assumes app-level filtering.
      allow create: if isUserAuthenticated();
      allow update: if isUserAuthenticated() && (isCreator(resource.data) || isActivityOwner() || isManagement());
      allow delete: if isManagement();
    }
    
    // INVOICES: Linked to opportunities.
    match /invoices/{invoiceId} {
      function isInvoiceOwner() {
        let opp = get(/databases/$(database)/documents/opportunities/$(resource.data.opportunityId));
        let client = get(/databases/$(database)/documents/clients/$(opp.data.clientId));
        return client.data.ownerId == request.auth.uid;
      }

      allow list: if isUserAuthenticated();
      allow get, create, update: if isUserAuthenticated() && (isInvoiceOwner() || isManagement());
      allow delete: if isManagement();
    }
    
    // CANJES: Complex logic, handled by roles.
    match /canjes/{canjeId} {
      allow read: if isUserAuthenticated();
      allow create: if isUserAuthenticated();
      allow update: if isUserAuthenticated() && (isCreator(resource.data) || isOwner(resource.data) || isManagement());
      allow delete: if isManagement();
    }
    
    // PROGRAMS & COMMERCIAL ITEMS (Grilla): Managed by admins/bosses. Read by all.
    match /programs/{programId} {
      allow read: if isUserAuthenticated();
      allow create, update, delete: if isManagement();
    }
    
    match /commercial_items/{itemId} {
      allow read: if isUserAuthenticated();
      allow create: if isUserAuthenticated();
      allow update, delete: if isUserAuthenticated();
    }

    // LICENCIAS: Users can create/read their own. Managers can read/update all.
    match /licencias/{licenciaId} {
      allow read, list: if isUserAuthenticated();
      allow create: if isUserAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isUserAuthenticated() && (isCreator(resource.data) || isManagement());
      allow delete: if isManagement();
    }

    // SYSTEM CONFIG: Only readable by management to prevent errors, write only by super admin.
    match /system_config/{configId} {
      allow read: if isUserAuthenticated() && isManagement();
      allow write: if isUserAuthenticated() && request.auth.token.email == 'lchena@airedesantafe.com.ar';
    }
  }
}
